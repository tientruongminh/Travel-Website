<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Khám phá | Quảng Ninh Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --brand: #0ea5a3;
      --brand-ink: #0b6b64;
      --chip-bg: #e6fbf8;
      --radius: 16px;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.5;
    }

    /* Layout */
    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 16px 40px;
      min-height: 100vh;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, #f6f8fbe6, #f6f8fb00);
      backdrop-filter: saturate(1.2) blur(4px);
      padding-top: 8px;
    }

    .toprow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .back {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: var(--brand-ink);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .back:hover {
      background: rgba(14, 165, 163, 0.1);
    }

    .back .material-icons {
      font-size: 20px;
    }

    /* Search */
    .search {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 16px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03);
      transition: box-shadow 0.2s ease;
    }

    .search:focus-within {
      box-shadow: 0 0 0 3px rgba(14, 165, 163, 0.1);
      border-color: var(--brand);
    }

    .search input {
      flex: 1;
      border: 0;
      outline: 0;
      font-size: 15px;
      background: transparent;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(2, 8, 23, 0.08);
    }

    .pill.active {
      background: var(--chip-bg);
      border-color: #bce7e1;
      color: var(--brand-ink);
      font-weight: 600;
    }

    .pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 99px;
    }

    .dot-tour { background: #0ea5a3; }
    .dot-svc { background: #8b5cf6; }
    .dot-evt { background: #ef4444; }

    /* Meta bar */
    .metabar {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--line);
    }

    .count {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }

    .pagesize {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    select {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 10px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    /* List */
    .list {
      margin-top: 20px;
      display: grid;
      gap: 16px;
    }

    .item {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      padding: 16px;
      box-shadow: 0 2px 10px rgba(2, 8, 23, 0.04);
      transition: all 0.3s ease;
    }

    .item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(2, 8, 23, 0.08);
    }

    .item img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 12px;
      background: #f1f5f9;
    }

    .item-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .item-header {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
    }

    .item h3 {
      margin: 0;
      font-size: 18px;
      line-height: 1.25;
      color: var(--text);
    }

    .tag {
      font-size: 12px;
      background: var(--chip-bg);
      color: var(--brand-ink);
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 700;
      white-space: nowrap;
    }

    .meta {
      font-size: 13px;
      color: var(--muted);
    }

    .desc {
      margin: 4px 0;
      color: #334155;
      font-size: 14px;
      line-height: 1.5;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: auto;
    }

    .btn {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 12px;
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(2, 8, 23, 0.08);
    }

    .btn.primary {
      background: var(--brand);
      border-color: #11c0be;
      color: #fff;
    }

    .btn .material-icons {
      font-size: 18px;
    }

    /* Pagination */
    .pager {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-top: 32px;
      flex-wrap: wrap;
    }

    .pagebtn {
      min-width: 40px;
      min-height: 36px;
      padding: 6px 12px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .pagebtn:hover:not([disabled]) {
      background: #f8fafc;
    }

    .pagebtn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .pagebtn.active {
      background: var(--brand);
      border-color: #11c0be;
      color: #fff;
    }

    /* Empty & skeleton */
    .empty {
      margin: 40px auto;
      padding: 40px 20px;
      border: 1px dashed var(--line);
      border-radius: 14px;
      text-align: center;
      color: #475569;
      background: #fff;
      max-width: 400px;
    }

    .empty .material-icons {
      font-size: 48px;
      color: #cbd5e1;
      margin-bottom: 16px;
    }

    .skeleton {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: #fff;
      padding: 16px;
      overflow: hidden;
      position: relative;
    }

    .shimmer {
      animation: shimmer 1.2s infinite linear;
      background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
      background-size: 200% 100%;
    }

    .sk-img {
      height: 110px;
      border-radius: 12px;
    }

    .sk-line {
      height: 12px;
      border-radius: 6px;
      margin: 6px 0;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 28px;
      transform: translateX(-50%) translateY(20px);
      background: #0f766e;
      color: #fff;
      border-radius: 999px;
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      box-shadow: 0 10px 30px rgba(15, 118, 110, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 50;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast .material-icons {
      font-size: 18px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .item {
        grid-template-columns: 1fr;
      }
      
      .item img {
        height: 180px;
      }
      
      .toprow {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .metabar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .pagesize {
        justify-content: space-between;
      }
      
      .filters {
        justify-content: center;
      }
      
      .actions {
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .wrap {
        padding: 16px 12px 32px;
      }
      
      .pill {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .btn {
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .item {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <a class="back" href="index.html">
          <span class="material-icons">arrow_back</span>
          Quay lại bản đồ
        </a>
        <div class="search" role="search">
          <span class="material-icons" aria-hidden="true">search</span>
          <input id="q" type="text" placeholder="Tìm theo tên, mô tả, danh mục..." aria-label="Tìm kiếm địa điểm" />
        </div>
      </div>
      
      <div class="filters" role="tablist" aria-label="Bộ lọc danh mục">
        <button id="filterAll" class="pill active" role="tab" aria-selected="true">
          <span class="material-icons">all_inclusive</span>
          Tất cả
        </button>
        <button id="filterTour" class="pill" role="tab" aria-selected="false">
          <span class="dot dot-tour"></span>
          Du lịch
        </button>
        <button id="filterSvc" class="pill" role="tab" aria-selected="false">
          <span class="dot dot-svc"></span>
          Sản phẩm
        </button>
        <button id="filterEvt" class="pill" role="tab" aria-selected="false">
          <span class="dot dot-evt"></span>
          Sự kiện
        </button>
      </div>
      
      <div class="metabar">
        <div class="count" id="resultCount">Đang tải…</div>
        <div class="pagesize">
          Hiển thị
          <select id="pageSize">
            <option value="6">6</option>
            <option value="9" selected>9</option>
            <option value="12">12</option>
            <option value="18">18</option>
            <option value="24">24</option>
          </select>
          mục mỗi trang
        </div>
      </div>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
    <div id="pager" class="pager" aria-label="Phân trang"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <span class="material-icons">bookmark_added</span>
    Đã lưu vào Cá nhân
  </div>

  <script>
    // Utilities
    const esc = s => (s||'').toString().replace(/[&<>"']/g, m => ({ 
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' 
    }[m]));
    
    const catLabel = t => ({
      tour: 'Du lịch', 
      service: 'Sản phẩm', 
      event: 'Sự kiện', 
      evt: 'Sự kiện', 
      svc: 'Sản phẩm'
    })[t] || 'Khác';

    // Map id -> media list
    window.spotMediaMap = {};

    // Fallback image SVG
    const FALLBACK_IMG =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
  <rect width="100%" height="100%" fill="#f1f5f9"/>
  <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
        font-family="system-ui,-apple-system,Segoe UI,Roboto" font-size="28" fill="#94a3b8">
    Không có ảnh
  </text>
</svg>`);

    // Khi ảnh thumb lỗi, thử lấy ảnh đầu tiên trong media. Nếu cũng không có, dùng placeholder SVG nhúng sẵn
    function imgOnError(imgEl, id) {
      try {
        const list = window.spotMediaMap?.[id] || [];
        const altImg = list.find(x => x && x.type === "image" && x.url)?.url;
        if (altImg && imgEl.dataset.fallback !== "true") {
          imgEl.dataset.fallback = "true";
          imgEl.src = altImg;
          return;
        }
      } catch (e) {
        console.warn("imgOnError", e);
      }
      // Cuối cùng rơi về placeholder nhúng sẵn, không cần file
      imgEl.src = FALLBACK_IMG;
      imgEl.alt = "Ảnh không khả dụng";
    }

    // State
    let all = [], filtered = [], mode = 'all';
    let page = 1, pageSize = 9;

    // Initialize
    init();

    async function init() {
      showSkeleton();
      try {
        const base = await fetch('data/spots.json?v=3').then(r => r.json()).catch(() => []);
        const user = JSON.parse(localStorage.getItem('qn_user_points') || '[]');
        all = normalize(base).concat(normalize(user));

        // Lưu lại media theo id để dùng khi ảnh thumb lỗi
        window.spotMediaMap = Object.fromEntries(
          all.map(p => [p.id, Array.isArray(p.media) ? p.media : []])
        );

        filtered = all.slice();
        apply();
      } catch (e) {
        console.error('Lỗi tải dữ liệu:', e);
        showError();
      }
    }

    function normalize(arr = []) {
      return arr.map(s => {
        const firstMediaImg =
          Array.isArray(s.media) && s.media.length > 0
            ? (s.media.find(m => m.type === "image")?.url || "")
            : "";

        return {
          id: s.id || Math.random().toString(36).slice(2, 10),
          name: s.name || "Điểm",
          category: (s.category || s.typeCategory || s.typeCat || "tour").toLowerCase(),
          type: (s.type || "play").toLowerCase(),
          lat: s.lat ?? (Array.isArray(s.coords) ? s.coords[0] : 0),
          lng: s.lng ?? (Array.isArray(s.coords) ? s.coords[1] : 0),
          desc: s.desc || s.description || "",
          thumb: s.thumb || firstMediaImg || FALLBACK_IMG,
          media: Array.isArray(s.media) ? s.media : [],
        };
      });
    }

    // Filtering + Search
    function apply() {
      const kw = document.getElementById('q').value?.trim().toLowerCase() || '';
      filtered = all.filter(p => {
        const okCat = mode === 'all' ? true :
          (mode === 'tour' ? p.category === 'tour' :
           mode === 'service' ? (p.category === 'service' || p.category === 'svc') :
           mode === 'event' ? (p.category === 'event' || p.category === 'evt') : true);
        
        const okKw = !kw ||
          p.name.toLowerCase().includes(kw) ||
          (p.desc || '').toLowerCase().includes(kw) ||
          catLabel(p.category).toLowerCase().includes(kw);
        
        return okCat && okKw;
      });
      page = 1;
      render();
    }

    // Render list + pagination
    function render() {
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;

      const start = (page - 1) * pageSize;
      const end = Math.min(start + pageSize, total);
      const slice = filtered.slice(start, end);

      document.getElementById('resultCount').textContent = total
        ? `Có ${total} địa điểm • Hiển thị ${start + 1} đến ${end}`
        : `Không tìm thấy địa điểm phù hợp`;

      const box = document.getElementById('list');
      
      if (!total) {
        box.innerHTML = `
          <div class="empty">
            <span class="material-icons">search_off</span>
            <h3>Không tìm thấy kết quả</h3>
            <p>Thử đổi từ khóa tìm kiếm hoặc bộ lọc danh mục</p>
          </div>
        `;
        document.getElementById('pager').innerHTML = '';
        return;
      }

      box.innerHTML = slice.map(p => `
        <article class="item">
          <img
            src="${esc(p.thumb || '')}"
            alt="${esc(p.name)}"
            loading="lazy"
            data-id="${esc(p.id)}"
            onerror="imgOnError(this, this.dataset.id)"
          >
          <div class="item-content">
            <div class="item-header">
              <h3>${esc(p.name)}</h3>
              <span class="tag">${catLabel(p.category)}</span>
            </div>
            <div class="meta">Tọa độ: ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</div>
            <p class="desc">${esc(p.desc || '')}</p>
            <div class="actions">
              <a class="btn primary" href="detail.html?id=${encodeURIComponent(p.id)}" target="_blank" rel="noopener">
                <span class="material-icons">info</span>
                Xem chi tiết
              </a>
              <a class="btn" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}" target="_blank" rel="noopener">
                <span class="material-icons">navigation</span>
                Chỉ đường
              </a>
              <button class="btn" onclick="saveFav('${p.id}')" aria-label="Lưu địa điểm">
                <span class="material-icons">bookmark_add</span>
                Lưu
              </button>
            </div>
          </div>
        </article>
      `).join('');

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const el = document.getElementById('pager');
      const maxShown = 7;
      let pages = [];
      
      if (totalPages <= maxShown) {
        for (let i = 1; i <= totalPages; i++) pages.push(i);
      } else {
        const left = Math.max(2, page - 2);
        const right = Math.min(totalPages - 1, page + 2);
        pages = [1];
        if (left > 2) pages.push('…');
        for (let i = left; i <= right; i++) pages.push(i);
        if (right < totalPages - 1) pages.push('…');
        pages.push(totalPages);
      }

      const btn = (label, p, disabled = false, active = false) =>
        `<button class="pagebtn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''} data-page="${p}">${label}</button>`;

      let html = '';
      html += btn('<span class="material-icons">chevron_left</span>', page - 1, page === 1, false);
      pages.forEach(n => {
        if (n === '…') html += `<span style="padding:6px 4px;color:#94a3b8">…</span>`;
        else html += btn(n, n, false, n === page);
      });
      html += btn('<span class="material-icons">chevron_right</span>', page + 1, page === totalPages, false);
      el.innerHTML = html;

      // Add event listeners
      [...el.querySelectorAll('.pagebtn')].forEach(b => {
        b.onclick = () => {
          const p = +b.getAttribute('data-page');
          if (!isNaN(p)) {
            page = p;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        };
      });
    }

    // Save favorite with toast
    function saveFav(id) {
      const key = 'qn_saved';
      const a = JSON.parse(localStorage.getItem(key) || '[]');
      if (!a.includes(id)) {
        a.push(id);
        localStorage.setItem(key, JSON.stringify(a));
        showToast();
      }
    }

    function showToast() {
      const t = document.getElementById('toast');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1400);
    }

    function showError() {
      document.getElementById('list').innerHTML = `
        <div class="empty">
          <span class="material-icons">error</span>
          <h3>Lỗi tải dữ liệu</h3>
          <p>Vui lòng thử lại sau hoặc kiểm tra kết nối mạng</p>
        </div>
      `;
    }

    function showSkeleton() {
      const box = document.getElementById('list');
      const sk = () => `
        <div class="skeleton">
          <div class="shimmer sk-img"></div>
          <div>
            <div class="shimmer sk-line" style="width:60%"></div>
            <div class="shimmer sk-line" style="width:40%"></div>
            <div class="shimmer sk-line" style="width:90%;height:10px"></div>
            <div class="shimmer sk-line" style="width:70%;height:10px"></div>
            <div class="shimmer sk-line" style="width:80%;height:36px;margin-top:12px"></div>
          </div>
        </div>`;
      box.innerHTML = sk() + sk() + sk() + sk() + sk();
      document.getElementById('pager').innerHTML = '';
      document.getElementById('resultCount').textContent = 'Đang tải…';
    }

    // Event listeners
    let tSearch;
    document.getElementById('q').addEventListener('input', () => {
      clearTimeout(tSearch);
      tSearch = setTimeout(apply, 220);
    });

    const pills = {
      all: document.getElementById('filterAll'),
      tour: document.getElementById('filterTour'),
      service: document.getElementById('filterSvc'),
      event: document.getElementById('filterEvt'),
    };

    Object.entries(pills).forEach(([k, btn]) => {
      btn.onclick = () => {
        mode = k;
        Object.values(pills).forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        apply();
      };
    });

    const sizeSel = document.getElementById('pageSize');
    pageSize = +sizeSel.value || 9;
    sizeSel.onchange = () => {
      pageSize = +sizeSel.value || 9;
      page = 1;
      render();
    };

    // Keyboard navigation
    window.addEventListener('keydown', e => {
      const totalPages = Math.max(1, Math.ceil((filtered?.length || 0) / pageSize));
      if (e.key === 'ArrowLeft' && page > 1) {
        page--;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (e.key === 'ArrowRight' && page < totalPages) {
        page++;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  </script>
</body>
</html>